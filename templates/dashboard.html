{% extends "base.html" %}

{% block title %}Dashboard - Baby Activity Tracker{% endblock %}

{% block content %}
{% if not activities %}
<!-- Welcome/Landing Page for First Time Users -->
<div class="hero-section">
    <div class="hero-content">
        <h1 class="hero-title">Welcome to Baby Activity Tracker</h1>
        <p class="hero-subtitle">Track your baby's daily routine with ease. Monitor sleep, feeding, and diaper changes all in one place.</p>
    </div>

    <div class="features-grid">
        <div class="feature-card">
            <div class="feature-icon sleep-icon">üí§</div>
            <h3>Sleep Tracking</h3>
            <p>Monitor sleep patterns and duration to understand your baby's rest schedule</p>
        </div>

        <div class="feature-card">
            <div class="feature-icon feeding-icon">üçº</div>
            <h3>Feeding Times</h3>
            <p>Keep track of feeding sessions and maintain consistent feeding schedules</p>
        </div>

        <div class="feature-card">
            <div class="feature-icon diaper-icon">üß∑</div>
            <h3>Diaper Changes</h3>
            <p>Record diaper changes to monitor your baby's health and routine</p>
        </div>
    </div>

    <div class="quick-add hero-quick-add">
        <h2>Get Started - Log Your First Activity</h2>
        <p class="quick-add-description">Click any button below to quickly add an activity, or use the detailed form for more information.</p>
        <div class="quick-add-buttons">
            <button class="quick-btn sleep-btn" onclick="quickAdd('sleep')" aria-label="Log sleep activity">
                <span class="btn-icon">üí§</span>
                <span class="btn-text">Sleep</span>
            </button>
            <button class="quick-btn feeding-btn" onclick="quickAdd('feeding')" aria-label="Log feeding activity">
                <span class="btn-icon">üçº</span>
                <span class="btn-text">Feeding</span>
            </button>
            <button class="quick-btn diaper-btn" onclick="quickAdd('diaper')" aria-label="Log diaper change">
                <span class="btn-icon">üß∑</span>
                <span class="btn-text">Diaper</span>
            </button>
            <button class="quick-btn play-btn" onclick="quickAdd('play')" aria-label="Log play activity">
                <span class="btn-icon">üé®</span>
                <span class="btn-text">Play</span>
            </button>
        </div>
        <a href="/add" class="btn-detailed">Use Detailed Form</a>
    </div>
</div>

{% else %}
<!-- Regular Dashboard with Activities -->
<div class="dashboard">
    {% if profile %}
    <div class="profile-banner">
        {% if profile.photo_path %}
        <img src="{{ profile.photo_path }}" alt="{{ profile.name }}" class="profile-photo-small">
        {% endif %}
        <div class="profile-details">
            <h3>{{ profile.name }}</h3>
            <p class="profile-birthday">Born: {{ profile.birthday }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Quick Add Section (moved to top for better UX) -->
    <div class="quick-add">
        <h3>Quick Add Activity</h3>
        <div class="quick-add-buttons">
            <button class="quick-btn sleep-btn" onclick="quickAdd('sleep')" aria-label="Log sleep activity">
                <span class="btn-icon">üí§</span>
                <span class="btn-text">Sleep</span>
            </button>
            <button class="quick-btn feeding-btn" onclick="quickAdd('feeding')" aria-label="Log feeding activity">
                <span class="btn-icon">üçº</span>
                <span class="btn-text">Feeding</span>
            </button>
            <button class="quick-btn diaper-btn" onclick="quickAdd('diaper')" aria-label="Log diaper change">
                <span class="btn-icon">üß∑</span>
                <span class="btn-text">Diaper</span>
            </button>
            <button class="quick-btn play-btn" onclick="quickAdd('play')" aria-label="Log play activity">
                <span class="btn-icon">üé®</span>
                <span class="btn-text">Play</span>
            </button>
        </div>
    </div>

    <!-- Activity Statistics -->
    <div class="activity-stats">
        <div class="stat-card">
            <span class="stat-number">{{ activities|selectattr('activity_type', 'equalto', 'sleep')|list|length }}</span>
            <span class="stat-label">Sleep Sessions</span>
        </div>
        <div class="stat-card">
            <span class="stat-number">{{ activities|selectattr('activity_type', 'equalto', 'feeding')|list|length }}</span>
            <span class="stat-label">Feedings</span>
        </div>
        <div class="stat-card">
            <span class="stat-number">{{ activities|selectattr('activity_type', 'equalto', 'diaper')|list|length }}</span>
            <span class="stat-label">Diaper Changes</span>
        </div>
        <div class="stat-card">
            <span class="stat-number">{{ activities|selectattr('activity_type', 'equalto', 'play')|list|length }}</span>
            <span class="stat-label">Play Sessions</span>
        </div>
    </div>

    <!-- Dashboard Header with Tabs -->
    <div class="dashboard-header">
        <h2>Activities</h2>
        <div class="filter-buttons" role="tablist" aria-label="Activity filters">
            <button class="filter-btn active" data-filter="all" role="tab" aria-selected="true" aria-controls="activities-panel">All</button>
            <button class="filter-btn" data-filter="sleep" role="tab" aria-selected="false" aria-controls="activities-panel">üí§ Sleep</button>
            <button class="filter-btn" data-filter="feeding" role="tab" aria-selected="false" aria-controls="activities-panel">üçº Feeding</button>
            <button class="filter-btn" data-filter="diaper" role="tab" aria-selected="false" aria-controls="activities-panel">üß∑ Diaper</button>
            <button class="filter-btn" data-filter="play" role="tab" aria-selected="false" aria-controls="activities-panel">üé® Play</button>
        </div>
    </div>

    <!-- Activities List Panel -->
    <div class="activities-list" id="activities-panel" role="tabpanel" aria-label="Activity list">
        {% for activity in activities %}
        <article class="activity-card {{ activity.activity_type }}" data-type="{{ activity.activity_type }}">
            <div class="activity-header">
                <span class="activity-type-badge">
                    {% if activity.activity_type == 'sleep' %}üí§{% elif activity.activity_type == 'feeding' %}üçº{% elif activity.activity_type == 'diaper' %}üß∑{% elif activity.activity_type == 'play' %}üé®{% else %}üìù{% endif %}
                    {{ activity.activity_type|title }}
                </span>
                <div class="activity-actions">
                    <a href="/edit/{{ activity.id }}" class="btn-edit" aria-label="Edit {{ activity.activity_type }} activity">Edit</a>
                    <button onclick="deleteActivity({{ activity.id }})" class="btn-delete" aria-label="Delete {{ activity.activity_type }} activity">Delete</button>
                </div>
            </div>
            <div class="activity-body">
                <p class="activity-time">
                    <strong>Start:</strong> <span class="local-time" data-utc="{{ activity.start_time.isoformat() }}">{{ activity.start_time.strftime('%Y-%m-%d %H:%M') }}</span>
                    {% if activity.end_time %}
                    <br><strong>End:</strong> <span class="local-time" data-utc="{{ activity.end_time.isoformat() }}">{{ activity.end_time.strftime('%Y-%m-%d %H:%M') }}</span>
                    <br><strong>Duration:</strong> {{ ((activity.end_time - activity.start_time).total_seconds() / 60)|round|int }} minutes
                    {% endif %}
                    {% if activity.role %}
                    <br><strong>By:</strong> {{ activity.role }}
                    {% endif %}
                </p>
                {% if activity.notes %}
                <p class="activity-notes">üìù {{ activity.notes }}</p>
                {% endif %}
            </div>
        </article>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Convert UTC times to local timezone
function convertToLocalTime() {
    console.log('Starting timezone conversion...');
    const elements = document.querySelectorAll('.local-time');
    console.log('Found', elements.length, 'elements to convert');

    elements.forEach(element => {
        const utcTime = element.dataset.utc;
        console.log('UTC time from data attribute:', utcTime);

        if (utcTime) {
            const date = new Date(utcTime);
            console.log('Parsed date object:', date);
            console.log('Local time string:', date.toString());

            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            };
            const converted = date.toLocaleString(undefined, options);
            console.log('Converted to local:', converted);
            element.textContent = converted;
        }
    });
    console.log('Timezone conversion complete');
}

// Run on page load
console.log('Registering load event listener');
window.addEventListener('load', function() {
    console.log('Page loaded, converting times');
    convertToLocalTime();
});

// Filter functionality with accessibility
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Update active button and ARIA attributes
        document.querySelectorAll('.filter-btn').forEach(b => {
            b.classList.remove('active');
            b.setAttribute('aria-selected', 'false');
        });
        this.classList.add('active');
        this.setAttribute('aria-selected', 'true');

        const filter = this.dataset.filter;
        const cards = document.querySelectorAll('.activity-card');
        let visibleCount = 0;

        cards.forEach(card => {
            if (filter === 'all' || card.dataset.type === filter) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        // Announce filter change to screen readers
        const announcement = `Showing ${visibleCount} ${filter === 'all' ? '' : filter} ${visibleCount === 1 ? 'activity' : 'activities'}`;
        console.log(announcement);
    });
});

// Quick add function
async function quickAdd(type) {
    const now = new Date().toISOString();
    const activity = {
        activity_type: type,
        start_time: now
    };

    try {
        const response = await fetch('/api/activities/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(activity)
        });

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to add activity');
        }
    } catch (error) {
        alert('Error adding activity: ' + error);
    }
}

// Delete activity function
async function deleteActivity(id) {
    if (!confirm('Are you sure you want to delete this activity?')) {
        return;
    }

    try {
        const response = await fetch(`/api/activities/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to delete activity');
        }
    } catch (error) {
        alert('Error deleting activity: ' + error);
    }
}
</script>
{% endblock %}
