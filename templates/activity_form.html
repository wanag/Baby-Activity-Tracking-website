{% extends "base.html" %}

{% block title %}{% if activity %}Edit{% else %}Add{% endif %} Activity - Baby Activity Tracker{% endblock %}

{% block content %}
<div class="form-container">
    <h2>{% if activity %}Edit{% else %}Add New{% endif %} Activity</h2>

    <form id="activityForm" class="activity-form">
        <div class="form-group">
            <label for="activity_type">Activity Type</label>
            <select id="activity_type" name="activity_type" required>
                <option value="">Select activity type...</option>
                <option value="sleep" {% if activity and activity.activity_type == 'sleep' %}selected{% endif %}>Sleep</option>
                <option value="feeding" {% if activity and activity.activity_type == 'feeding' %}selected{% endif %}>Feeding</option>
                <option value="diaper" {% if activity and activity.activity_type == 'diaper' %}selected{% endif %}>Diaper Change</option>
            </select>
        </div>

        <div class="form-group">
            <label for="role">Your Role</label>
            <select id="role" name="role">
                <option value="">Select your role...</option>
                <option value="Mom" {% if activity and activity.role == 'Mom' %}selected{% endif %}>Mom</option>
                <option value="Dad" {% if activity and activity.role == 'Dad' %}selected{% endif %}>Dad</option>
                <option value="Grandparent" {% if activity and activity.role == 'Grandparent' %}selected{% endif %}>Grandparent</option>
                <option value="Caregiver" {% if activity and activity.role == 'Caregiver' %}selected{% endif %}>Caregiver</option>
                <option value="Other" {% if activity and activity.role == 'Other' %}selected{% endif %}>Other</option>
            </select>
        </div>

        <div class="form-group">
            <label for="start_time">Start Time</label>
            <input
                type="datetime-local"
                id="start_time"
                name="start_time"
                required
                {% if activity %}data-utc="{{ activity.start_time.isoformat() }}"{% endif %}
            >
        </div>

        <div class="form-group">
            <label for="end_time">End Time (Optional)</label>
            <input
                type="datetime-local"
                id="end_time"
                name="end_time"
                {% if activity and activity.end_time %}data-utc="{{ activity.end_time.isoformat() }}"{% endif %}
            >
        </div>

        <div class="form-group">
            <label for="notes">Notes (Optional)</label>
            <textarea
                id="notes"
                name="notes"
                rows="4"
                placeholder="Add any additional notes..."
            >{% if activity %}{{ activity.notes or '' }}{% endif %}</textarea>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary">
                {% if activity %}Update{% else %}Add{% endif %} Activity
            </button>
            <a href="/" class="btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('activityForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const role = formData.get('role') || null;

    // Remember the selected role for next time
    if (role) {
        localStorage.setItem('lastUsedRole', role);
    }

    const data = {
        activity_type: formData.get('activity_type'),
        start_time: new Date(formData.get('start_time')).toISOString(),
        end_time: formData.get('end_time') ? new Date(formData.get('end_time')).toISOString() : null,
        notes: formData.get('notes') || null,
        role: role
    };

    try {
        {% if activity %}
        // Update existing activity
        const response = await fetch('/api/activities/{{ activity.id }}', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        {% else %}
        // Create new activity
        const response = await fetch('/api/activities/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        {% endif %}

        if (response.ok) {
            window.location.href = '/';
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to save activity'));
        }
    } catch (error) {
        alert('Error saving activity: ' + error);
    }
});

// Convert UTC to local time for editing, or set current time for new activity
window.addEventListener('load', () => {
    {% if activity %}
    // Convert UTC times to local for editing
    const startInput = document.getElementById('start_time');
    const endInput = document.getElementById('end_time');

    if (startInput.dataset.utc) {
        const startDate = new Date(startInput.dataset.utc);
        const year = startDate.getFullYear();
        const month = String(startDate.getMonth() + 1).padStart(2, '0');
        const day = String(startDate.getDate()).padStart(2, '0');
        const hours = String(startDate.getHours()).padStart(2, '0');
        const minutes = String(startDate.getMinutes()).padStart(2, '0');
        startInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    if (endInput.dataset.utc) {
        const endDate = new Date(endInput.dataset.utc);
        const year = endDate.getFullYear();
        const month = String(endDate.getMonth() + 1).padStart(2, '0');
        const day = String(endDate.getDate()).padStart(2, '0');
        const hours = String(endDate.getHours()).padStart(2, '0');
        const minutes = String(endDate.getMinutes()).padStart(2, '0');
        endInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    {% else %}
    // Set default to current local time for new activity
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('start_time').value = `${year}-${month}-${day}T${hours}:${minutes}`;

    // Pre-fill role with last used value
    const lastUsedRole = localStorage.getItem('lastUsedRole');
    if (lastUsedRole) {
        document.getElementById('role').value = lastUsedRole;
    }
    {% endif %}
});
</script>
{% endblock %}
