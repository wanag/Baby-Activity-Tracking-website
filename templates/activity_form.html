{% extends "base.html" %}

{% block title %}{% if activity %}Edit{% else %}Add{% endif %} Activity - Baby Activity Tracker{% endblock %}

{% block content %}
<div class="form-container">
    <h2>{% if activity %}‚úèÔ∏è Edit{% else %}‚ûï Add New{% endif %} Activity</h2>

    <form id="activityForm" class="activity-form" novalidate>
        <div class="form-group">
            <label for="activity_type">
                Activity Type <span style="color: var(--color-danger);">*</span>
            </label>
            <select id="activity_type" name="activity_type" required aria-required="true">
                <option value="">Select activity type...</option>
                <option value="sleep" {% if activity and activity.activity_type == 'sleep' %}selected{% endif %}>üí§ Sleep</option>
                <option value="feeding" {% if activity and activity.activity_type == 'feeding' %}selected{% endif %}>üçº Feeding</option>
                <option value="diaper" {% if activity and activity.activity_type == 'diaper' %}selected{% endif %}>üß∑ Diaper Change</option>
            </select>
            <small class="form-help">Choose the type of activity you want to track</small>
        </div>

        <div class="form-group">
            <label for="role">Your Role</label>
            <select id="role" name="role" aria-label="Select your role">
                <option value="">Select your role (optional)...</option>
                <option value="Mom" {% if activity and activity.role == 'Mom' %}selected{% endif %}>üë© Mom</option>
                <option value="Dad" {% if activity and activity.role == 'Dad' %}selected{% endif %}>üë® Dad</option>
                <option value="Grandparent" {% if activity and activity.role == 'Grandparent' %}selected{% endif %}>üëµ Grandparent</option>
                <option value="Caregiver" {% if activity and activity.role == 'Caregiver' %}selected{% endif %}>üë§ Caregiver</option>
                <option value="Other" {% if activity and activity.role == 'Other' %}selected{% endif %}>üë• Other</option>
            </select>
            <small class="form-help">Who is performing this activity? (Your last selection will be remembered)</small>
        </div>

        <div class="form-group">
            <label for="start_time">
                Start Time <span style="color: var(--color-danger);">*</span>
            </label>
            <input
                type="datetime-local"
                id="start_time"
                name="start_time"
                required
                aria-required="true"
                {% if activity %}data-utc="{{ activity.start_time.isoformat() }}"{% endif %}
            >
            <small class="form-help">When did this activity start?</small>
        </div>

        <div class="form-group">
            <label for="end_time">End Time</label>
            <input
                type="datetime-local"
                id="end_time"
                name="end_time"
                aria-label="Optional end time"
                {% if activity and activity.end_time %}data-utc="{{ activity.end_time.isoformat() }}"{% endif %}
            >
            <small class="form-help">Leave empty if the activity is still ongoing</small>
        </div>

        <div class="form-group">
            <label for="notes">Notes</label>
            <textarea
                id="notes"
                name="notes"
                rows="4"
                placeholder="Add any additional notes or observations..."
                aria-label="Optional notes"
            >{% if activity %}{{ activity.notes or '' }}{% endif %}</textarea>
            <small class="form-help">Any additional details you'd like to remember</small>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary" id="submitBtn">
                <span id="submitText">{% if activity %}Update{% else %}Add{% endif %} Activity</span>
                <span id="submitLoader" class="loading-spinner hidden"></span>
            </button>
            <a href="/" class="btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('activityForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    // Show loading state
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const submitLoader = document.getElementById('submitLoader');

    submitBtn.disabled = true;
    submitText.classList.add('hidden');
    submitLoader.classList.remove('hidden');

    const formData = new FormData(e.target);
    const role = formData.get('role') || null;

    // Remember the selected role for next time
    if (role) {
        localStorage.setItem('lastUsedRole', role);
    }

    const data = {
        activity_type: formData.get('activity_type'),
        start_time: new Date(formData.get('start_time')).toISOString(),
        end_time: formData.get('end_time') ? new Date(formData.get('end_time')).toISOString() : null,
        notes: formData.get('notes') || null,
        role: role
    };

    try {
        {% if activity %}
        // Update existing activity
        const response = await fetch('/api/activities/{{ activity.id }}', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        {% else %}
        // Create new activity
        const response = await fetch('/api/activities/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        {% endif %}

        if (response.ok) {
            window.location.href = '/';
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to save activity'));

            // Reset loading state
            submitBtn.disabled = false;
            submitText.classList.remove('hidden');
            submitLoader.classList.add('hidden');
        }
    } catch (error) {
        alert('Error saving activity: ' + error);

        // Reset loading state
        submitBtn.disabled = false;
        submitText.classList.remove('hidden');
        submitLoader.classList.add('hidden');
    }
});

// Convert UTC to local time for editing, or set current time for new activity
window.addEventListener('load', () => {
    {% if activity %}
    // Convert UTC times to local for editing
    const startInput = document.getElementById('start_time');
    const endInput = document.getElementById('end_time');

    if (startInput.dataset.utc) {
        const startDate = new Date(startInput.dataset.utc);
        const year = startDate.getFullYear();
        const month = String(startDate.getMonth() + 1).padStart(2, '0');
        const day = String(startDate.getDate()).padStart(2, '0');
        const hours = String(startDate.getHours()).padStart(2, '0');
        const minutes = String(startDate.getMinutes()).padStart(2, '0');
        startInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    if (endInput.dataset.utc) {
        const endDate = new Date(endInput.dataset.utc);
        const year = endDate.getFullYear();
        const month = String(endDate.getMonth() + 1).padStart(2, '0');
        const day = String(endDate.getDate()).padStart(2, '0');
        const hours = String(endDate.getHours()).padStart(2, '0');
        const minutes = String(endDate.getMinutes()).padStart(2, '0');
        endInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    {% else %}
    // Set default to current local time for new activity
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('start_time').value = `${year}-${month}-${day}T${hours}:${minutes}`;

    // Pre-fill role with last used value
    const lastUsedRole = localStorage.getItem('lastUsedRole');
    if (lastUsedRole) {
        document.getElementById('role').value = lastUsedRole;
    }
    {% endif %}
});
</script>
{% endblock %}
